name: Deploy Worker and Build Daily

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy-worker:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy Worker
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: deploy
          
      - name: Output Worker URL
        run: |
          echo "âœ… Worker éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ”— Worker URL: ${{ steps.deploy.outputs.deployment-url }}"
          echo ""
          echo "ğŸ“‹ è¯·å°†æ­¤ URL æ·»åŠ åˆ° GitHub Variablesï¼š"
          echo "   - WRITE_RSS_URL: ${{ steps.deploy.outputs.deployment-url }}/writeRssData"
          echo "   - RSS_FEED_URL: ${{ steps.deploy.outputs.deployment-url }}/getRss"

  build-daily:
    needs: deploy-worker
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    
    steps:
      - name: Checkout book branch
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
      - name: Archive old daily notes
        run: |
          echo "ğŸ“ å½’æ¡£æ—§æ—¥åˆŠ..."
          if [ -d "daily" ]; then
            LATEST_FILE=$(find daily -maxdepth 1 -name "*.md" | sort -r | head -n 1)
            if [ -n "$LATEST_FILE" ]; then
              LATEST_MONTH=$(basename "$LATEST_FILE" .md | cut -d'-' -f1,2)
              for file in daily/*.md; do
                [ -e "$file" ] || continue
                FILE_MONTH=$(basename "$file" .md | cut -d'-' -f1,2)
                if [ "$FILE_MONTH" != "$LATEST_MONTH" ]; then
                  mkdir -p "daily/$FILE_MONTH"
                  mv "$file" "daily/$FILE_MONTH/"
                  echo "  å½’æ¡£: $file -> daily/$FILE_MONTH/"
                fi
              done
            fi
          fi
          
      - name: Trigger daily content generation
        run: |
          if [ -n "${{ vars.WRITE_RSS_URL }}" ]; then
            echo "ğŸ¤– è§¦å‘æ—¥æŠ¥ç”Ÿæˆ..."
            TODAY=$(TZ="Asia/Shanghai" date +%Y-%m-%d)
            curl -fsS --retry 3 "${{ vars.WRITE_RSS_URL }}?date=$TODAY" || echo "âš ï¸ è§¦å‘å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          else
            echo "âš ï¸ WRITE_RSS_URL æœªè®¾ç½®ï¼Œè·³è¿‡è§¦å‘"
          fi
          
      - name: Download RSS
        run: |
          if [ -n "${{ vars.RSS_FEED_URL }}" ]; then
            echo "ğŸ“¥ ä¸‹è½½ RSS Feed..."
            wget -O rss.xml "${{ vars.RSS_FEED_URL }}" --timeout=30 --tries=3 || echo "âš ï¸ RSS ä¸‹è½½å¤±è´¥"
          fi
          
      - name: Commit changes
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "docs: è‡ªåŠ¨æ›´æ–°æ—¥æŠ¥ $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "âœ… å·²æäº¤æ—¥æŠ¥æ›´æ–°"
          else
            echo "â„¹ï¸ æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi
